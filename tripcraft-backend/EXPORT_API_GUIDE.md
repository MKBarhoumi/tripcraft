# TripCraft Export API Guide

Complete documentation for the PDF export endpoint in the TripCraft API.

## Table of Contents
- [Overview](#overview)
- [Endpoint](#endpoint)
- [PDF Format](#pdf-format)
- [Supabase Storage](#supabase-storage)
- [Usage Examples](#usage-examples)
- [Best Practices](#best-practices)
- [Error Handling](#error-handling)
- [Troubleshooting](#troubleshooting)

---

## Overview

The Export API allows users to generate and download beautifully formatted PDF documents of their trip itineraries. The PDFs include:

- **Trip Details**: Destination, dates, duration, budget information
- **Daily Itinerary**: Day-by-day schedule with activities, times, and locations
- **Budget Breakdown**: Categorized expense list with totals
- **Notes**: Personal travel notes and reminders

The generated PDFs can be:
- Shared with travel companions
- Printed for offline reference
- Archived for future trips
- Submitted for expense reports

### Key Features

‚úÖ **Professional formatting** with colors and tables  
‚úÖ **Comprehensive content** including all trip details  
‚úÖ **Supabase Storage integration** for cloud hosting  
‚úÖ **Fallback to base64** when storage isn't configured  
‚úÖ **Unicode support** for international destinations  
‚úÖ **Automatic timestamps** in filenames  

---

## Endpoint

### POST /api/trips/{trip_id}/export

Generates a PDF export of a trip itinerary and returns either a download URL (if Supabase is configured) or the PDF as base64-encoded data.

#### Authentication
Requires a valid JWT token in the `Authorization` header.

#### Path Parameters

| Parameter | Type | Required | Description |
|-----------|------|----------|-------------|
| `trip_id` | integer | Yes | The ID of the trip to export |

#### Request Headers

```
Authorization: Bearer <your_jwt_token>
```

#### Response (Supabase Configured)

**Status Code**: `200 OK`

```json
{
  "success": true,
  "filename": "trip_123_20240601_143022.pdf",
  "size_bytes": 45678,
  "download_url": "https://your-project.supabase.co/storage/v1/object/public/trip-exports/user_1/trip_123_20240601_143022.pdf",
  "storage_path": "user_1/trip_123_20240601_143022.pdf"
}
```

#### Response (Supabase Not Configured)

**Status Code**: `200 OK`

```json
{
  "success": true,
  "filename": "trip_123_20240601_143022.pdf",
  "size_bytes": 45678,
  "download_url": null,
  "pdf_base64": "JVBERi0xLjQKJeLjz9MKMSAwIG9iago8PC9UeXBlL...",
  "message": "Supabase not configured. PDF returned as base64."
}
```

#### Error Responses

| Status Code | Description | Response Body |
|-------------|-------------|---------------|
| 401 | Not authenticated | `{"detail": "Not authenticated"}` |
| 403 | User doesn't own trip | `{"detail": "Not authorized to export this trip"}` |
| 404 | Trip not found | `{"detail": "Trip not found"}` |
| 500 | PDF generation failed | `{"detail": "Failed to generate PDF: ..."}` |
| 500 | Storage upload failed | `{"detail": "Failed to upload PDF to storage: ..."}` |
| 503 | ReportLab not installed | `{"detail": "PDF generation service unavailable. ReportLab not installed."}` |

---

## PDF Format

The generated PDFs follow a professional, well-structured format:

### Title Page
- **Trip Destination** (large, blue heading)
- **Date Range** in full format (e.g., "June 1, 2024 - June 3, 2024")
- **Duration** in days
- **Budget Amount** (if specified)
- **Budget Tier** (Budget, Moderate, Luxury)
- **Travel Style** (Cultural, Adventure, Relaxation, etc.)

### Itinerary Section
For each day:
- **Day Header**: "Day X: Weekday, Month DD, YYYY"
- **Activity Table** with:
  - Time column (formatted as "HH:MM AM/PM")
  - Activity details column:
    - Activity name (bold)
    - Location with üìç icon (if provided)
    - Description (if provided)
- Gray background with grid lines for easy reading

### Budget Breakdown Section
- **Category-based grouping**:
  - Accommodation
  - Transportation
  - Food
  - Activities
  - Shopping
  - Other
- **Each item** shows:
  - Category (only once per group)
  - Description
  - Amount (right-aligned, formatted as $X,XXX.XX)
- **Total row** at bottom with bold formatting

### Notes Section
- Each note displayed as:
  - **Title** (bold, if provided)
  - Content
- Chronologically ordered by creation date

### Footer
- "Generated by TripCraft on [Date]"
- Gray, centered text

---

## Supabase Storage

### Configuration

To enable cloud storage for PDFs, configure these environment variables:

```env
SUPABASE_URL=https://your-project.supabase.co
SUPABASE_KEY=your-supabase-anon-key
SUPABASE_BUCKET=trip-exports
```

### Storage Structure

PDFs are organized by user:

```
trip-exports/
‚îú‚îÄ‚îÄ user_1/
‚îÇ   ‚îú‚îÄ‚îÄ trip_5_20240601_120000.pdf
‚îÇ   ‚îú‚îÄ‚îÄ trip_5_20240615_143000.pdf
‚îÇ   ‚îî‚îÄ‚îÄ trip_8_20240701_090000.pdf
‚îú‚îÄ‚îÄ user_2/
‚îÇ   ‚îî‚îÄ‚îÄ trip_12_20240620_170000.pdf
‚îî‚îÄ‚îÄ ...
```

### Bucket Setup

1. **Create Bucket** in Supabase Storage:
   - Name: `trip-exports`
   - Public: Yes (for download URLs)

2. **Set Policies** (optional for private storage):
   ```sql
   -- Allow users to upload their own PDFs
   CREATE POLICY "Users can upload their PDFs"
   ON storage.objects FOR INSERT
   WITH CHECK (
     bucket_id = 'trip-exports' AND
     auth.uid()::text = (storage.foldername(name))[1]
   );

   -- Allow users to read their own PDFs
   CREATE POLICY "Users can read their PDFs"
   ON storage.objects FOR SELECT
   USING (
     bucket_id = 'trip-exports' AND
     auth.uid()::text = (storage.foldername(name))[1]
   );
   ```

### Filename Format

```
trip_{trip_id}_{timestamp}.pdf
```

Example: `trip_123_20240601_143022.pdf`

- `trip_id`: The database ID of the trip
- `timestamp`: Generation time in `YYYYMMDD_HHMMSS` format

---

## Usage Examples

### Python (requests)

```python
import requests
import base64

# Export trip
response = requests.post(
    "http://localhost:8000/api/trips/123/export",
    headers={"Authorization": f"Bearer {token}"}
)

if response.status_code == 200:
    data = response.json()
    
    if data["download_url"]:
        # Supabase configured - download from URL
        print(f"Download PDF: {data['download_url']}")
        
        # Or download directly
        pdf_response = requests.get(data["download_url"])
        with open(data["filename"], "wb") as f:
            f.write(pdf_response.content)
    
    elif data["pdf_base64"]:
        # No Supabase - decode base64
        pdf_bytes = base64.b64decode(data["pdf_base64"])
        with open(data["filename"], "wb") as f:
            f.write(pdf_bytes)
        
        print(f"PDF saved as {data['filename']}")
        print(f"Size: {data['size_bytes']} bytes")
```

### Flutter (Dart)

```dart
import 'dart:convert';
import 'dart:io';
import 'package:http/http.dart' as http;
import 'package:path_provider/path_provider.dart';
import 'package:url_launcher/url_launcher.dart';

Future<void> exportTrip(int tripId, String token) async {
  final response = await http.post(
    Uri.parse('http://localhost:8000/api/trips/$tripId/export'),
    headers: {'Authorization': 'Bearer $token'},
  );

  if (response.statusCode == 200) {
    final data = jsonDecode(response.body);
    
    if (data['download_url'] != null) {
      // Supabase configured - open download URL
      final url = Uri.parse(data['download_url']);
      if (await canLaunchUrl(url)) {
        await launchUrl(url);
      }
    } else if (data['pdf_base64'] != null) {
      // No Supabase - save base64 PDF locally
      final pdfBytes = base64Decode(data['pdf_base64']);
      
      // Get documents directory
      final directory = await getApplicationDocumentsDirectory();
      final file = File('${directory.path}/${data['filename']}');
      
      // Write PDF
      await file.writeAsBytes(pdfBytes);
      
      print('PDF saved: ${file.path}');
      
      // Open PDF (requires pdf viewer package)
      // Navigator.push(context, MaterialPageRoute(
      //   builder: (_) => PdfViewerPage(filePath: file.path)
      // ));
    }
  } else {
    throw Exception('Export failed: ${response.body}');
  }
}
```

### cURL

```bash
# Export trip
curl -X POST "http://localhost:8000/api/trips/123/export" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -o trip_export.json

# If Supabase configured - download from URL
download_url=$(jq -r '.download_url' trip_export.json)
curl -o trip.pdf "$download_url"

# If no Supabase - decode base64
jq -r '.pdf_base64' trip_export.json | base64 -d > trip.pdf
```

### JavaScript (Fetch)

```javascript
async function exportTrip(tripId, token) {
  const response = await fetch(`http://localhost:8000/api/trips/${tripId}/export`, {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${token}`
    }
  });

  if (!response.ok) {
    throw new Error(`Export failed: ${response.status}`);
  }

  const data = await response.json();

  if (data.download_url) {
    // Supabase configured - open download
    window.open(data.download_url, '_blank');
  } else if (data.pdf_base64) {
    // No Supabase - download base64 PDF
    const binaryString = atob(data.pdf_base64);
    const bytes = new Uint8Array(binaryString.length);
    for (let i = 0; i < binaryString.length; i++) {
      bytes[i] = binaryString.charCodeAt(i);
    }
    
    const blob = new Blob([bytes], { type: 'application/pdf' });
    const url = URL.createObjectURL(blob);
    
    // Trigger download
    const a = document.createElement('a');
    a.href = url;
    a.download = data.filename;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }
}
```

---

## Best Practices

### 1. Export Before Sharing
Always export the latest version before sharing with others to ensure all updates are included.

### 2. Check File Size
For trips with many activities:
```python
if data["size_bytes"] > 10_000_000:  # 10 MB
    print("Warning: Large PDF. Consider splitting the trip.")
```

### 3. Cache Download URLs
If using Supabase, download URLs are permanent. Cache them to avoid regenerating:

```python
# Store URL in database
trip.pdf_url = data["download_url"]
trip.pdf_updated_at = datetime.now()
session.commit()

# Use cached URL if trip hasn't changed
if trip.pdf_url and trip.updated_at < trip.pdf_updated_at:
    return trip.pdf_url
else:
    # Regenerate
    return export_trip(trip_id)
```

### 4. Handle Errors Gracefully
```python
try:
    response = export_trip(trip_id, token)
except requests.exceptions.HTTPError as e:
    if e.response.status_code == 403:
        print("You don't have permission to export this trip")
    elif e.response.status_code == 404:
        print("Trip not found")
    elif e.response.status_code == 503:
        print("PDF service unavailable. Try again later.")
    else:
        print(f"Export failed: {e}")
```

### 5. Progress Indicators
PDF generation can take a few seconds for large trips. Show progress:

```dart
// Flutter example
bool isExporting = false;

Future<void> exportTrip() async {
  setState(() { isExporting = true; });
  
  try {
    final result = await api.exportTrip(tripId);
    // Handle result
  } finally {
    setState(() { isExporting = false; });
  }
}
```

### 6. Offline Support
If using base64 PDFs, store them locally for offline access:

```dart
// Save base64 to local database
await db.insert('cached_pdfs', {
  'trip_id': tripId,
  'pdf_base64': data['pdf_base64'],
  'cached_at': DateTime.now().toIso8601String()
});
```

### 7. Print Optimization
PDFs use letter size (8.5" x 11") by default, suitable for printing:

```python
# Change page size if needed (in export.py)
doc = SimpleDocTemplate(buffer, pagesize=A4)  # For A4 paper
```

### 8. Accessibility
Ensure users know the export is available:

```dart
// Show export option in UI
ListTile(
  leading: Icon(Icons.picture_as_pdf),
  title: Text('Export as PDF'),
  subtitle: Text('Download a formatted itinerary'),
  onTap: () => exportTrip(trip.id),
)
```

---

## Error Handling

### Common Errors

#### 1. ReportLab Not Installed (503)
```json
{
  "detail": "PDF generation service unavailable. ReportLab not installed."
}
```

**Solution**: Install ReportLab on the server:
```bash
pip install reportlab==4.0.9
```

#### 2. Trip Not Found (404)
```json
{
  "detail": "Trip not found"
}
```

**Causes**:
- Invalid trip ID
- Trip was deleted
- Database connection issue

**Solution**: Verify trip exists and ID is correct.

#### 3. Unauthorized (403)
```json
{
  "detail": "Not authorized to export this trip"
}
```

**Causes**:
- Trying to export another user's trip
- Token belongs to wrong user

**Solution**: Ensure user owns the trip.

#### 4. Supabase Upload Failed (500)
```json
{
  "detail": "Failed to upload PDF to storage: ..."
}
```

**Causes**:
- Invalid Supabase credentials
- Bucket doesn't exist
- Storage policies blocking upload
- Network issues

**Solution**: 
1. Check environment variables
2. Verify bucket exists in Supabase
3. Check storage policies
4. Test Supabase connection

#### 5. PDF Generation Failed (500)
```json
{
  "detail": "Failed to generate PDF: ..."
}
```

**Causes**:
- Unicode characters not supported by font
- Malformed trip data
- Memory issues for very large trips

**Solution**:
1. Check for special characters
2. Validate trip data
3. Increase server memory if needed

---

## Troubleshooting

### PDF Not Downloading

**Symptom**: Export succeeds but PDF doesn't download

**Checks**:
1. Verify `download_url` in response
2. Check browser's download settings
3. Test URL directly in browser
4. Check Supabase bucket is public

**Solution**:
```python
# Test URL accessibility
import requests
response = requests.head(download_url)
if response.status_code != 200:
    print("URL not accessible")
```

### Base64 PDF Corrupt

**Symptom**: Decoded PDF won't open

**Checks**:
1. Verify base64 decoding
2. Check for newlines in base64 string
3. Verify PDF magic number (`%PDF`)

**Solution**:
```python
import base64

# Proper decoding
pdf_bytes = base64.b64decode(pdf_base64)

# Verify PDF
if pdf_bytes[:4] != b'%PDF':
    raise ValueError("Invalid PDF data")
```

### Large PDFs Failing

**Symptom**: Export times out or fails for trips with many activities

**Solution**:
1. Increase server timeout
2. Paginate very long itineraries
3. Optimize image sizes (if added in future)
4. Use background jobs for large exports

```python
# FastAPI timeout configuration
from fastapi import FastAPI
import uvicorn

app = FastAPI()

if __name__ == "__main__":
    uvicorn.run(
        app,
        timeout_keep_alive=120  # Increase timeout
    )
```

### Unicode Characters Not Rendering

**Symptom**: Special characters appear as boxes or missing

**Solution**: ReportLab uses standard fonts by default. For full unicode support, register custom fonts:

```python
from reportlab.pdfbase import pdfmetrics
from reportlab.pdfbase.ttfonts import TTFont

# Register unicode-supporting font
pdfmetrics.registerFont(TTFont('DejaVu', 'DejaVuSans.ttf'))

# Use in styles
body_style = ParagraphStyle(
    'CustomBody',
    fontName='DejaVu',
    fontSize=11
)
```

### Supabase Connection Issues

**Symptom**: Upload fails with connection errors

**Checks**:
1. Verify `SUPABASE_URL` and `SUPABASE_KEY`
2. Test connection manually:
   ```python
   from supabase import create_client
   
   client = create_client(
       "https://your-project.supabase.co",
       "your-key"
   )
   
   # Test bucket access
   buckets = client.storage.list_buckets()
   print(buckets)
   ```
3. Check network/firewall rules

---

## Dependencies

### Required
- **ReportLab** >= 4.0.9 - PDF generation
  ```bash
  pip install reportlab==4.0.9
  ```

### Optional
- **Supabase** >= 2.10.0 - Cloud storage
  ```bash
  pip install supabase==2.10.0
  ```

### Installation

```bash
# Install all dependencies
cd tripcraft-backend
pip install -r requirements.txt

# Or manually
pip install reportlab==4.0.9 supabase==2.10.0
```

---

## Performance

### Generation Times

| Trip Size | Activities | Time |
|-----------|-----------|------|
| Small (1-2 days) | < 10 | < 1s |
| Medium (3-5 days) | 10-30 | 1-2s |
| Large (6-10 days) | 30-60 | 2-4s |
| Very Large (10+ days) | 60+ | 4-8s |

### File Sizes

| Content | Approximate Size |
|---------|-----------------|
| Minimal trip (1 day, no budget) | 5-10 KB |
| Standard trip (3 days, basic itinerary) | 15-30 KB |
| Detailed trip (5 days, full budget, notes) | 40-80 KB |
| Comprehensive trip (10+ days, all features) | 100-200 KB |

### Optimization Tips

1. **Use caching** for frequently exported trips
2. **Background jobs** for bulk exports
3. **CDN** for Supabase storage URLs
4. **Compression** (PDFs are already compressed by ReportLab)

---

## API Integration Checklist

- [ ] Install ReportLab on server
- [ ] Configure Supabase (optional)
- [ ] Test export with sample trip
- [ ] Handle base64 PDFs if no Supabase
- [ ] Implement download in client
- [ ] Add loading indicators
- [ ] Test with unicode destinations
- [ ] Test with minimal/maximal data
- [ ] Handle all error cases
- [ ] Add export option to UI

---

## Next Steps

1. **Test the endpoint** with your trips
2. **Configure Supabase** for cloud storage
3. **Integrate into your frontend** app
4. **Customize PDF styling** if needed
5. **Add export analytics** to track usage

For questions or issues, refer to the main [README](./README.md) or create an issue in the repository.

---

**Happy Exporting! ‚úàÔ∏èüìÑ**
